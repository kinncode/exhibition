<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/nav.css">
    <script src="js/main.js"></script>
    <title>é‚£äº›å¹´æˆ‘å€‘ä¸€èµ·çš„å›æ†¶ - ç”Ÿå‘½æ•…äº‹æˆæœå±•</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Serif TC', 'Noto Sans TC', 'Microsoft JhengHei', serif;
            background: 
                radial-gradient(circle at 20% 50%, rgba(160, 130, 109, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(139, 111, 71, 0.05) 0%, transparent 50%),
                linear-gradient(135deg, #faf8f5 0%, #f5e6d3 100%);
            color: #4a3f35;
            line-height: 1.9;
            min-height: 100vh;
            letter-spacing: 0.3px;
        }
        
        main {
            padding-top: 100px;
            padding-bottom: 4rem;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem;
        }

        .page-header {
            text-align: center;
            margin-bottom: 4rem;
            animation: fadeIn 0.8s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .page-header h1 {
            font-size: 3rem;
            color: #8b6f47;
            margin-bottom: 1rem;
        }

        .page-header p {
            font-size: 1.2rem;
            color: #7a6a5a;
        }

        .class-section {
            margin-bottom: 5rem;
        }

        .class-title {
            font-size: 2rem;
            color: #8b6f47;
            margin-bottom: 2.5rem;
            padding-left: 1rem;
            position: relative;
            font-weight: 600;
        }

        .class-title::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 4px;
            height: 70%;
            background: #a0826d;
            border-radius: 2px;
        }

        .gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 2rem;
        }

        .work-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(139, 111, 71, 0.1);
            transition: transform 0.3s, box-shadow 0.3s;
            cursor: pointer;
        }

        .work-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 16px rgba(139, 111, 71, 0.2);
        }

        .work-image {
            width: 100%;
            height: auto;
            object-fit: cover;
            background: linear-gradient(135deg, rgba(160, 130, 109, 0.2), rgba(139, 111, 71, 0.2));
        }

        .work-image-placeholder {
            width: 100%;
            height: 300px;
            background: linear-gradient(135deg, rgba(160, 130, 109, 0.2), rgba(139, 111, 71, 0.2));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            color: #a0826d;
        }

        .work-info {
            padding: 0.8rem 1rem;
        }

        .work-title {
            font-size: 1rem;
            color: #8b6f47;
            font-weight: 600;
            margin-bottom: 0.3rem;
        }

        .work-author {
            font-size: 0.85rem;
            color: #7a6a5a;
            margin-bottom: 0.3rem;
        }

        .work-description {
            font-size: 0.9rem;
            color: #6b5d4f;
            line-height: 1.6;
        }

        /* Lightbox */
        .lightbox {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .lightbox.active {
            display: flex;
        }

        .lightbox-content {
            max-width: 90%;
            max-height: 90vh;
            position: relative;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .lightbox-image {
            max-width: 100%;
            max-height: 65vh;
            object-fit: contain;
            border-radius: 8px 8px 0 0;
            flex-shrink: 0;
            cursor: zoom-in;
            transition: transform 0.3s ease;
            transform-origin: center center;
        }

        .lightbox-image.zoomed {
            cursor: zoom-out;
            max-height: none;
            max-width: none;
            width: auto;
            height: auto;
        }

        .lightbox-image-container {
            overflow: auto;
            max-height: 65vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px 8px 0 0;
        }

        .lightbox-info {
            background: white;
            padding: 1rem 1.5rem;
            border-radius: 0 0 8px 8px;
            max-width: 100%;
            max-height: 200px;
            overflow-y: auto;
            flex-shrink: 0;
        }

        .lightbox-close {
            position: absolute;
            top: -3rem;
            right: 0;
            width: 40px;
            height: 40px;
            background: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.5rem;
            color: #6b5d4f;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            z-index: 10;
        }

        .lightbox-close:hover {
            background: #a0826d;
            color: white;
            transform: rotate(90deg);
        }

        /* å°èˆªæŒ‰éˆ• */
        .lightbox-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 50px;
            height: 50px;
            background: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.5rem;
            color: #6b5d4f;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            z-index: 10;
        }

        .lightbox-nav:hover {
            background: #a0826d;
            color: white;
            transform: translateY(-50%) scale(1.1);
        }

        .lightbox-nav:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .lightbox-nav:disabled:hover {
            background: white;
            color: #6b5d4f;
            transform: translateY(-50%);
        }

        .lightbox-prev {
            left: -60px;
        }

        .lightbox-next {
            right: -60px;
        }

        /* è¨ˆæ•¸å™¨ */
        .lightbox-counter {
            position: absolute;
            top: -3rem;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
            color: #6b5d4f;
        }

        footer {
            background: rgba(139, 111, 71, 0.1);
            padding: 3rem 2rem;
            text-align: center;
            color: #7a6a5a;
            margin-top: 4rem;
        }

        footer p {
            margin-bottom: 0.5rem;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .page-header h1 {
                font-size: 2rem;
            }

            .class-title {
                font-size: 1.5rem;
            }

            .gallery {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
                gap: 1.5rem;
            }

            .lightbox {
                padding: 0;
            }

            .lightbox-content {
                max-width: 100%;
                max-height: 100vh;
                border-radius: 0;
            }

            .lightbox-image-container {
                max-height: 70vh;
                border-radius: 0;
            }

            .lightbox-image {
                max-height: 70vh;
                border-radius: 0;
            }

            .lightbox-info {
                border-radius: 0;
                padding: 1rem;
                max-height: 25vh;
            }

            .lightbox-close {
                top: 10px;
                right: 10px;
                width: 45px;
                height: 45px;
                font-size: 1.8rem;
                box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            }

            .lightbox-counter {
                top: 10px;
                left: 10px;
                transform: none;
                font-size: 0.85rem;
                padding: 0.4rem 0.8rem;
                box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            }

            .lightbox-prev,
            .lightbox-next {
                width: 45px;
                height: 45px;
                font-size: 1.3rem;
                box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            }

            .lightbox-prev {
                left: 10px;
                bottom: 10px;
                top: auto;
                transform: none;
            }

            .lightbox-next {
                right: 10px;
                bottom: 10px;
                top: auto;
                transform: none;
            }

            .lightbox-nav:hover {
                transform: scale(1.05);
            }

            .lightbox-nav:active {
                transform: scale(0.95);
            }
        }
    </style>
</head>
<body>
    <nav class="nav">
        <div class="nav-content">
            <div class="logo">ç”Ÿå‘½æ›¸å¯«æˆæœå±•</div>
            <div class="menu-toggle" id="menu-toggle">
                <span></span>
                <span></span>
                <span></span>
            </div>
            <ul class="nav-links" id="nav-links">
                <li><a href="index.html">é¦–é </a></li>
                <li>
                    <a href="#">ç”Ÿå‘½æ›¸å¯«</a>
                    <ul class="dropdown">
                        <li><a href="life-image.html">ç”Ÿå‘½åœ–åƒ</a></li>
                        <li><a href="life-video.html">ç”Ÿå‘½æ•…äº‹å½±ç‰‡</a></li>
                        <li><a href="life-story.html">ç”Ÿå‘½æ•…äº‹1000å­—</a></li>
                    </ul>
                </li>
                <li>
                    <a href="#">ä½³ä½œåˆ†äº«</a>
                    <ul class="dropdown">
                        <li><a href="resume.html">å‰µä½œå±¥æ­·è¡¨</a></li>
                        <li><a href="memories.html">é‚£äº›å¹´æˆ‘å€‘ä¸€èµ·çš„å›æ†¶</a></li>
                    </ul>
                </li>
                <li><a href="outline.html">èª²ç¨‹å¤§ç¶±</a></li>
                <li><a href="../daily/journal.html">å·¥ä½œæ—¥èªŒ</a></li>
                <li><a href="team.html">èª²ç¨‹åœ˜éšŠ</a></li>
                <li><a href="feedback.html">èª²ç¨‹å›é¥‹</a></li>
            </ul>
        </div>
    </nav>

    <main>
        <div class="container">
            <div class="page-header">
                <h1>ğŸ¨ é‚£äº›å¹´æˆ‘å€‘ä¸€èµ·çš„å›æ†¶ä½œå“</h1>
                <p>å±•ç¤ºå…¨ç­åŒå­¸çš„ç²¾å½©å‰µä½œ</p>
            </div>

            <div class="class-section">
                <h2 class="class-title">å¤šæ¨‚ä¸€ç”²ç­ä½œå“</h2>
                <div class="gallery" id="class1Gallery"></div>
            </div>

            <div class="class-section">
                <h2 class="class-title">é›»å­ä¸€ä¹™ç­ä½œå“</h2>
                <div class="gallery" id="class2Gallery"></div>
            </div>

            <div class="class-section">
                <h2 class="class-title">æµéŸ³ä¸€ä¹™ç­ä½œå“</h2>
                <div class="gallery" id="class3Gallery"></div>
            </div>
        </div>
    </main>

    <!-- Lightbox -->
    <div class="lightbox" id="lightbox">
        <div class="lightbox-content">
            <button class="lightbox-close" id="closeLightbox">Ã—</button>
            <div class="lightbox-counter" id="lightboxCounter"></div>
            <button class="lightbox-nav lightbox-prev" id="prevBtn">â®</button>
            <button class="lightbox-nav lightbox-next" id="nextBtn">â¯</button>
            <div class="lightbox-image-container" id="imageContainer">
                <img class="lightbox-image" id="lightboxImage" src="" alt="">
            </div>
            <div class="lightbox-info">
                <h3 class="work-title" id="lightboxTitle"></h3>
                <p class="work-author" id="lightboxAuthor"></p>
                <p class="work-description" id="lightboxDescription"></p>
            </div>
        </div>
    </div>

    <footer>
        <p>Â© 2025 ç”Ÿå‘½æ›¸å¯«æˆæœå±• | ä¸­æ–‡é–±è®€èˆ‡è¡¨é”èª²ç¨‹ | å—å°ç§‘æŠ€å¤§å­¸</p>
        <p>æŒ‡å°è€å¸«:é§±è‚²è±</p>
    </footer>

    <script>
        const worksData = {
            class1: [
                {
                    title: "åœ‹ä¸­å›æ†¶",
                    author: "ç¬¬å››çµ„",
                    
                    image: "img/me/A (1).jpg"
                },
                {
                    title: "åœ‹å°å›æ†¶",
                    author: "ç¬¬åå››çµ„",
                    
                    image: "img/me/A (2).jpg"
                },
                {
                    title: "é«˜ä¸­å›æ†¶",
                    author: "ç¬¬åä¸‰çµ„",
                     
                    image: "img/me/A (3).jpg"
                },
                {
                    title: "é«˜ä¸­å›æ†¶",
                    author: "ç¬¬ä¸€çµ„",
                    
                    image: "img/me/A (4).jpg"
                },
                {
                    title: "é«˜ä¸­å›æ†¶",
                    author: "ç¬¬äºŒå’Œç¬¬ä¸‰çµ„",
                
                    image: "img/me/A (5).jpg"
                },
                {
                    title: "é«˜ä¸­å›æ†¶",
                    author: "ç¬¬äº”çµ„",
                    
                    image: "img/me/A (6).jpg"
                },
                {
                    title: "è¦–è¦ºå›æ†¶",
                    author: "ç¬¬å…­çµ„",
                
                    image: "img/me/A (7).jpg"
                },
                {
                    title: "é«˜ä¸­å›æ†¶",
                    author: "ç¬¬ä¸ƒçµ„",
                    image: "img/me/A (8).jpg"
                },
                {
                    title: "é«˜ä¸­å›æ†¶",
                    author: "ç¬¬å…«çµ„",
                    image: "img/me/A (9).jpg"
                },
                {
                    title: "å—…è¦ºå›æ†¶",
                    author: "ç¬¬ä¹çµ„",
                    image: "img/me/A (10).jpg"
                },
                {
                    title: "å‘³è¦ºå›æ†¶",
                    author: "ç¬¬åçµ„",
                    image: "img/me/A (11).jpg"
                },
                {
                    title: "åœ‹ä¸­å›æ†¶",
                    author: "ç¬¬åä¸€çµ„",
                    image: "img/me/A (12).jpg"
                },
                {
                    title: "åœ‹ä¸­å›æ†¶",
                    author: "ç¬¬åäºŒçµ„",
                    image: "img/me/A (13).jpg"
                }
            ],
            class2: [
                {
                    title: "åœ‹å°å›æ†¶",
                    author: "ç¬¬å››çµ„",
                    
                    image: "img/me/B (1).jpg"
                },
                {
                    title: "åœ‹å°å›æ†¶",
                    author: "ç¬¬åå››çµ„",
                
                    image: "img/me/B (2).jpg"
                },
                {
                    title: "è¦–è¦ºçš„å›æ†¶",
                    author: "ç¬¬äº”çµ„",
                        
                    image: "img/me/B (3).jpg"
                },
                {
                    title: "è¦–è¦ºçš„å›æ†¶",
                    author: "ç¬¬åäº”çµ„",
                    
                    image: "img/me/B (4).jpg"
                },
                {
                    title: "è½è¦ºçš„å›æ†¶",
                    author: "ç¬¬å…­çµ„",
                    
                    image: "img/me/B (5).jpg"
                },
              {
                    title: "åœ‹ä¸­çš„å›æ†¶",
                    author: "ç¬¬ä¹çµ„",
                        
                    image: "img/me/B (6).jpg"
                },
                {
                    title: "è½è¦ºçš„å›æ†¶",
                    author: "ç¬¬ä¸ƒçµ„",
                    
                    image: "img/me/B (7).jpg"
                },
                {
                    title: "é«˜ä¸­çš„å›æ†¶",
                    author: "ç¬¬å…«çµ„",
                        
                    image: "img/me/B (8).jpg"
                },
                {
                    title: "é‚£äº›å¹´æˆ‘å€‘ä¸€èµ·çš„ç«¥å¹´çš„å›æ†¶",
                    author: "ç¬¬åäºŒçµ„",
                    
                    image: "img/me/B (9).jpg"
                },
                {
                    title: "é«˜ä¸­çš„å›æ†¶",
                    author: "ç¬¬åçµ„",
                    
                    image: "img/me/B (10).jpg"
                },
                {
                    title: "è¦–è¦ºçš„å›æ†¶",
                    author: "ç¬¬äºŒçµ„",
                        
                    image: "img/me/B (11).jpg"
                },
                {
                    title: "è½è¦ºçš„å›æ†¶",
                    author: "ç¬¬åä¸‰çµ„",
                        
                    image: "img/me/B (12).jpg"
                },
                {
                    title: "é«˜ä¸­çš„å›æ†¶",
                    author: "ç¬¬ä¸€çµ„",
                    
                    image: "img/me/B (13).jpg"
                },
                {
                    title: "åœ‹ä¸­çš„å›",
                    author: "ç¬¬ä¸‰çµ„",
                    
                    image: "img/me/B (14).jpg"
                }
            ],
            class3: [
                {
                    title: "è¦–è¦ºçš„å›æ†¶",
                    author: "ç¬¬å››çµ„ï¼Œç¬¬å…«çµ„",
                        
                    image: "img/me/C (1).jpg"
                },
                {
                    title: "è¦–è¦ºçš„å›æ†¶",
                    author: "ç¬¬äºŒçµ„ï¼Œç¬¬äº”çµ„",
                
                    image: "img/me/C (2).jpg"
                },
                {
                    title: "é«˜ä¸­çš„å›æ†¶",
                    author: "ç¬¬ä¸€çµ„",
                        
                   image: "img/me/C (3).jpg"
                },
                {
                    title: "è½è¦ºçš„å›æ†¶",
                    author: "ç¬¬ä¸ƒçµ„",
                    
                    image: "img/me/C (4).jpg"
                },
                {
                    title: "é«˜ä¸­çš„å›æ†¶",
                    author: "ç¬¬ä¸‰çµ„",
                        
                    image: "img/me/C (5).jpg"
                }
            ]
        };
// ç•¶å‰ç‹€æ…‹
let currentClass = '';
let currentIndex = 0;

// åœ–ç‰‡é è¼‰å…¥å¿«å–
const imageCache = new Map();

// å„ªåŒ–çš„åœ–ç‰‡é è¼‰å…¥å‡½æ•¸
function preloadImage(src) {
    return new Promise((resolve, reject) => {
        if (imageCache.has(src)) {
            resolve(imageCache.get(src));
            return;
        }

        const img = new Image();
        
        // ä½¿ç”¨ decode() API æå‡æ€§èƒ½ï¼ˆæ”¯æ´ç¾ä»£ç€è¦½å™¨ï¼‰
        img.onload = () => {
            if ('decode' in img) {
                img.decode()
                    .then(() => {
                        imageCache.set(src, img);
                        resolve(img);
                    })
                    .catch(() => {
                        imageCache.set(src, img);
                        resolve(img);
                    });
            } else {
                imageCache.set(src, img);
                resolve(img);
            }
        };
        
        img.onerror = reject;
        img.src = src;
    });
}

// æ‰¹æ¬¡é è¼‰å…¥åœ–ç‰‡ï¼ˆé™åˆ¶ä¸¦ç™¼æ•¸é‡ï¼‰
async function preloadImagesInBatches(images, batchSize = 3) {
    const results = [];
    for (let i = 0; i < images.length; i += batchSize) {
        const batch = images.slice(i, i + batchSize);
        const batchResults = await Promise.allSettled(
            batch.map(img => preloadImage(img))
        );
        results.push(...batchResults);
    }
    return results;
}

// ä½¿ç”¨ Intersection Observer å¯¦ç¾æ‡¶è¼‰å…¥
function setupLazyLoading() {
    const observerOptions = {
        root: null,
        rootMargin: '50px', // æå‰ 50px é–‹å§‹è¼‰å…¥
        threshold: 0.01
    };

    const imageObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const img = entry.target;
                const src = img.dataset.src;
                
                if (src && !img.src) {
                    preloadImage(src).then(() => {
                        img.src = src;
                        img.classList.add('loaded');
                    }).catch(() => {
                        img.outerHTML = '<div class="work-image-placeholder">ğŸ–¼ï¸</div>';
                    });
                    
                    imageObserver.unobserve(img);
                }
            }
        });
    }, observerOptions);

    return imageObserver;
}

// æ¸²æŸ“ç•«å»Šï¼ˆå„ªåŒ–ç‰ˆï¼‰
function renderGallery(classId, works) {
    const gallery = document.getElementById(classId + 'Gallery');
    
    if (!works || works.length === 0) {
        gallery.innerHTML = '<p style="text-align: center; color: #666;">æš«ç„¡ä½œå“</p>';
        return;
    }
    
    // ä½¿ç”¨ DocumentFragment æå‡æ€§èƒ½
    const fragment = document.createDocumentFragment();
    
    works.forEach((work, index) => {
        const card = document.createElement('div');
        card.className = 'work-card';
        card.onclick = () => openLightbox(classId, index);
        
        if (work.image) {
            // ä½¿ç”¨æ‡¶è¼‰å…¥
            card.innerHTML = `
                <img class="work-image" 
                     data-src="${work.image}" 
                     alt="${work.title}"
                     loading="lazy"
                     style="opacity: 0; transition: opacity 0.3s;">
                <div class="work-info">
                    <h3 class="work-title">${work.title}</h3>
                    <p class="work-author">ğŸ‘¤ ${work.author}</p>
                </div>
            `;
        } else {
            card.innerHTML = `
                <div class="work-image-placeholder">ğŸ–¼ï¸</div>
                <div class="work-info">
                    <h3 class="work-title">${work.title}</h3>
                    <p class="work-author">ğŸ‘¤ ${work.author}</p>
                </div>
            `;
        }
        
        fragment.appendChild(card);
    });
    
    gallery.appendChild(fragment);
    
    // è¨­ç½®æ‡¶è¼‰å…¥
    const images = gallery.querySelectorAll('img[data-src]');
    const observer = setupLazyLoading();
    images.forEach(img => {
        observer.observe(img);
        img.addEventListener('load', function() {
            this.style.opacity = '1';
        }, { once: true });
    });
}

// åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', () => {
    renderGallery('class1', worksData.class1);
    renderGallery('class2', worksData.class2);
    renderGallery('class3', worksData.class3);
    
    // é è¼‰å…¥ç¬¬ä¸€å€‹ç­ç´šçš„å‰å¹¾å¼µåœ–ç‰‡
    if (worksData.class1 && worksData.class1.length > 0) {
        const firstImages = worksData.class1
            .slice(0, 3)
            .map(work => work.image)
            .filter(Boolean);
        preloadImagesInBatches(firstImages, 2);
    }
});

// Lightbox å…ƒç´ 
const lightbox = document.getElementById('lightbox');
const closeLightbox = document.getElementById('closeLightbox');
const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');
const lightboxImage = document.getElementById('lightboxImage');
const imageContainer = document.getElementById('imageContainer');

// åœ–ç‰‡ç¸®æ”¾åŠŸèƒ½
let isZoomed = false;

lightboxImage.addEventListener('click', (e) => {
    e.stopPropagation();
    toggleZoom();
});

function toggleZoom() {
    isZoomed = !isZoomed;
    if (isZoomed) {
        lightboxImage.classList.add('zoomed');
        lightboxImage.style.transform = 'scale(2)';
        imageContainer.style.overflow = 'auto';
    } else {
        lightboxImage.classList.remove('zoomed');
        lightboxImage.style.transform = 'scale(1)';
        imageContainer.style.overflow = 'hidden';
    }
}

function resetZoom() {
    isZoomed = false;
    lightboxImage.classList.remove('zoomed');
    lightboxImage.style.transform = 'scale(1)';
    imageContainer.style.overflow = 'hidden';
}

// è§¸æ§æ‰‹å‹¢æ”¯æ´
let touchStartX = 0;
let touchEndX = 0;
let touchStartDistance = 0;

lightbox.addEventListener('touchstart', (e) => {
    if (e.touches.length === 2) {
        // é›™æŒ‡ç¸®æ”¾
        touchStartDistance = Math.hypot(
            e.touches[0].clientX - e.touches[1].clientX,
            e.touches[0].clientY - e.touches[1].clientY
        );
    } else if (e.touches.length === 1) {
        // å–®æŒ‡æ»‘å‹•
        touchStartX = e.touches[0].clientX;
    }
}, { passive: true });

lightbox.addEventListener('touchmove', (e) => {
    if (e.touches.length === 2 && touchStartDistance > 0) {
        // é›™æŒ‡ç¸®æ”¾
        const currentDistance = Math.hypot(
            e.touches[0].clientX - e.touches[1].clientX,
            e.touches[0].clientY - e.touches[1].clientY
        );
        const scaleChange = currentDistance / touchStartDistance;
        
        if (scaleChange > 1.2 && !isZoomed) {
            toggleZoom();
        } else if (scaleChange < 0.8 && isZoomed) {
            toggleZoom();
        }
    }
}, { passive: true });

lightbox.addEventListener('touchend', (e) => {
    if (e.changedTouches.length === 1) {
        touchEndX = e.changedTouches[0].clientX;
        handleSwipe();
    }
    touchStartDistance = 0;
}, { passive: true });

function handleSwipe() {
    const swipeThreshold = 50;
    const diff = touchStartX - touchEndX;

    if (Math.abs(diff) > swipeThreshold && !isZoomed) {
        if (diff > 0) {
            showNext();
        } else {
            showPrevious();
        }
    }
}

function openLightbox(classId, index) {
    currentClass = classId;
    currentIndex = index;
    resetZoom();
    showWork();
    lightbox.classList.add('active');
    
    // é è¼‰å…¥ç›¸é„°åœ–ç‰‡
    preloadAdjacentImages();
}

function showWork() {
    const works = worksData[currentClass];
    const work = works[currentIndex];
    
    resetZoom();
    
    // ä½¿ç”¨å¿«å–çš„åœ–ç‰‡æˆ–ç›´æ¥è¨­ç½®
    if (work.image) {
        if (imageCache.has(work.image)) {
            lightboxImage.src = work.image;
            lightboxImage.style.opacity = '1';
        } else {
            lightboxImage.style.opacity = '0';
            preloadImage(work.image).then(() => {
                lightboxImage.src = work.image;
                lightboxImage.style.opacity = '1';
            }).catch(() => {
                lightboxImage.src = '';
            });
        }
    } else {
        lightboxImage.src = '';
    }
    
    document.getElementById('lightboxTitle').textContent = work.title;
    document.getElementById('lightboxAuthor').textContent = 'ä½œè€…: ' + work.author;
    document.getElementById('lightboxDescription').textContent = work.description || '';
    document.getElementById('lightboxCounter').textContent = `${currentIndex + 1} / ${works.length}`;
    
    prevBtn.disabled = currentIndex === 0;
    nextBtn.disabled = currentIndex === works.length - 1;
}

// é è¼‰å…¥ç›¸é„°åœ–ç‰‡
function preloadAdjacentImages() {
    const works = worksData[currentClass];
    const imagesToPreload = [];
    
    // é è¼‰å…¥å‰ä¸€å¼µ
    if (currentIndex > 0 && works[currentIndex - 1].image) {
        imagesToPreload.push(works[currentIndex - 1].image);
    }
    
    // é è¼‰å…¥ä¸‹ä¸€å¼µ
    if (currentIndex < works.length - 1 && works[currentIndex + 1].image) {
        imagesToPreload.push(works[currentIndex + 1].image);
    }
    
    // æ‰¹æ¬¡é è¼‰å…¥
    if (imagesToPreload.length > 0) {
        preloadImagesInBatches(imagesToPreload, 2);
    }
}

function showPrevious() {
    if (currentIndex > 0) {
        currentIndex--;
        showWork();
        preloadAdjacentImages();
    }
}

function showNext() {
    const works = worksData[currentClass];
    if (currentIndex < works.length - 1) {
        currentIndex++;
        showWork();
        preloadAdjacentImages();
    }
}

// äº‹ä»¶ç›£è½
closeLightbox.addEventListener('click', () => {
    lightbox.classList.remove('active');
});

prevBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    showPrevious();
});

nextBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    showNext();
});

lightbox.addEventListener('click', (e) => {
    if (e.target === lightbox) {
        lightbox.classList.remove('active');
    }
});

// éµç›¤å°èˆª
document.addEventListener('keydown', (e) => {
    if (!lightbox.classList.contains('active')) return;
    
    if (e.key === 'Escape') {
        lightbox.classList.remove('active');
    } else if (e.key === 'ArrowLeft') {
        showPrevious();
    } else if (e.key === 'ArrowRight') {
        showNext();
    }
});
    </script>
</body>
</html>